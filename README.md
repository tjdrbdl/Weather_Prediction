# Weather Prediction: 시정 예측 모델

AI 해커톤 코드와 실제 공공데이터에 적용한 결과 기술

## Background

- **대회명**: 공군 AI 해커톤 2025
- **기간**: 2025.4 ~ 2025.7
- **본선 Task 2**: 기상 데이터를 활용한 다음날 최소 시정 및 시정 회복시간 예측

본 프로젝트는 공군 AI 해커톤 본선에서 사용한 코드를 기반으로, 기상청에서 제공하는 항공기상관측(METAR) 데이터를 가공 및 분석하여 시정 예측 모델을 구축합니다. 해커톤 당시의 코드를 리팩토링하고, 실제 공공데이터에 적용 가능한 자동화된 머신러닝 파이프라인 형태로 재현하였습니다.

---

## Features

- **자동화된 ML 파이프라인**: 데이터 전처리, 피처 엔지니어링, 모델 학습, 평가, 예측까지 전 과정을 자동화.
- **최적 모델 자동 선택**: `RandomForest`, `LGBM`, `XGBoost` 등 여러 후보 모델을 경쟁시켜, 각 예측 목표에 가장 적합한 모델을 자동으로 선정.
- **시계열 예측**: 전날(D-1)의 날씨 지표를 기반으로 다음날(D)의 시정(`min_visibility`, `recovery_1mile`, `recovery_3mile`)을 예측.
- **공공데이터 활용**: 기상청 항공기상관측 API를 통해 실제 데이터를 수집 및 처리.

---

## Code Details

- **`request_api.py`**:
  - 기상청 공공데이터 API를 통해 METAR 데이터를 수집.
  - API 키를 안전하게 관리하기 위해 `config.json` 파일 사용.
  - 특정 지점을 기준으로 분석하기 위해 STN(지점번호)는 110으로 통일.

- **`create_dataframe.py`**:
  - 수집된 원본 데이터를 파싱하여, 훈련/검증용(`train_validation.csv`)과 테스트용(`test.csv`) 데이터셋으로 분할 및 저장.

- **`prediciton_pipeline.py`**:
  - 데이터 전처리, 피처 엔지니어링, 모델 학습 및 예측을 수행하는 **메인 파이프라인**.
  - **주요 로직**:
    1. **데이터 전처리**: EDA 결과를 바탕으로 결측치 처리(선형 보간, 0 채우기), 파생 변수(`DPD`) 생성, 범주형 변수(`WC`) 그룹화 및 원-핫 인코딩 수행.
    2. **피처 엔지니어링**: 시간별(hourly) 데이터를 일별(daily) 와이드 포맷으로 변환 (`TA` -> `TA_h00`, `TA_h01`...).
    3. **모델링**:
        - **시계열 교차 검증**: 시간 순서를 유지하며 훈련/검증셋 분할 (`shuffle=False`)하여 데이터 누수 방지.
        - **모델 경쟁 시스템**: 여러 후보 모델을 학습시켜 가장 성능(`MAE` 기준)이 좋은 모델을 자동으로 선택.
        - **과적합 방지**: 하이퍼파라미터 튜닝을 통해 모델의 일반화 성능 향상.

- **`generate_visibility_targets.py`**:
  - 일별 집계 데이터로부터 예측 목표(타깃)인 최소 시정 및 시정 회복시간을 계산하는 함수 제공.

---

## How to Use

1.  **API 키 설정**:
    - `config.json` 파일에 기상청 공공데이터 포털에서 발급받은 API 키를 입력합니다.

2.  **데이터 수집**:
    - `request_api.py`를 실행하여 지정된 기간의 METAR 데이터를 수집하고 `data.txt`로 저장합니다.

3.  **데이터셋 생성**:
    - `create_dataframe.py`를 실행하여 `data.txt`를 `train_validation.csv`와 `test.csv`로 분할합니다.

4.  **모델 학습 및 예측**:
    - `prediciton_pipeline.py`를 실행합니다.
    - 이 스크립트는 데이터 로딩부터 예측 결과 저장까지 모든 과정을 자동으로 수행합니다.
    - 최종 예측 결과는 `predictions.csv`에, 테스트셋의 실제 정답은 `test_targets.csv`에 저장됩니다.

---

## EDA Results

EDA(탐색적 데이터 분석)를 통해 데이터의 특성과 변수 간 관계를 파악하였습니다. 주요 분석 결과는 다음과 같습니다:

### 1. 데이터 개요
- **데이터셋**: 기상청 항공기상관측(METAR) API를 통해 수집된 데이터.
- **주요 변수**:
  - `TM`: 관측 시각 (KST)
  - `STN`: 국내 지점번호
  - `WD`: 풍향 (16방위)
  - `WS`: 풍속 (knots)
  - `GST`: 돌풍속 (knots)
  - `VS`: 시정 (m)
  - `RVR1`: 1방향 활주로 시정 (m)
  - `RVR2`: 2방향 활주로 시정 (m)
  - `WC`: 현재일기 코드 (WMO 4677 기준)
  - 참고:https://www.nodc.noaa.gov/archive/arc0021/0002199/1.1/data/0-data/HTML/WMO-CODE/WMO4677.HTM
  - `CA`: 전운량 (1/8)
  - `CA1`: 1층 운량 (1/8)
  - `CT1`: 1층 운형
  - `CH1`: 1층 운고 (ft)
  - `CA2`: 2층 운량 (1/8)
  - `CT2`: 2층 운형
  - `CH2`: 2층 운고 (ft)
  - `CA3`: 3층 운량 (1/8)
  - `CT3`: 3층 운형
  - `CH3`: 3층 운고 (ft)
  - `CA4`: 4층 운량 (1/8)
  - `CT4`: 4층 운형
  - `CH4`: 4층 운고 (ft)
  - `TA`: 기온 (°C)
  - `TD`: 이슬점온도 (°C)
  - `HM`: 상대습도 (%)
  - `PA`: 현지기압 (hPa)
  - `PS`: 해면기압 (hPa)
  - `RN`: 강수량 (mm)
---

### 2. 결측치 분석
- **결측치가 있는 주요 변수**: 입력치가 없거나, 관측이 불가능한경우 -9로 표기됨
  - `WC` (현재일기 코드): 64.5% 결측
  - `CA1`, `CT1`, `CH1` (1층 운량, 운형, 운고): 29% 결측
  - `CA2`, `CT2`, `CH2` (2층 운량, 운형, 운고): 67% 결측
  - `TA`, `TD`, `HM` (기온, 이슬점 온도, 상대습도): 0.06% 결측
  - `RN` (강수량): 89% 결측
- **처리 방법 (파이프라인에 적용)**:
  - 결측치 비율이 높은 변수(`GST`, `RVR1`, `RVR2`)는 제거.
  - `WC` 및 구름 관련 변수(`CA`, `CT`, `CH`)는 0으로 대체.
  - `TA`, `TD`, `HM`은 선형 보간법으로 대체.
  - `RN`은 강수량이 없을 때를 의미하므로 0으로 대체.

---

### 3. 변수 간 상관관계
- **상관관계 분석 결과**:
  - `WS` (풍속)와 `VS` (시정): 양의 상관관계.
  - `TD` (이슬점 온도)와 `VS`: 음의 상관관계.
  - `RN` (강수량)과 `VS`: 음의 상관관계.
  - `HM` (상대습도)와 `VS`: 음의 상관관계.
  - `CH`, `CA`, `CT` (구름 관련 변수)와 `VS`: 저층운이 시정에 더 큰 영향을 미침.
- **파생변수 생성**:
  - `DPD`(이슬점감률 = 기온 - 이슬점온도)는 시정과 강한 음의 상관관계를 보여 핵심 피처로 활용.
  - `Pressure_Diff`: 해면기압(`PS`)과 현지기압(`PA`)의 차이, 실제로 VS와 연관 없음.

---

### 4. WC(현재일기 코드) 분석
- **값 분포**:
  - `WC` 값은 특정 코드(예: 00, 05, 61, 21 등)에 집중되어 있음.
  - 도메인 지식을 활용하여 그룹화(Grouping) 필요.
- **추천 전처리 방법**:
  - Encoding 또는 Grouping을 통해 범주형 변수로 변환.
  - 예: `00`(관측 불가), `10~19`(연무/안개), `50~59`(이슬비), `60~69`(비) 등으로 그룹화하여 파이프라인에 적용.

---

### 5. 시각화 결과
- **시정(VS) 분포**:
  - 시정 데이터는 특정 범위에 편향되어 있음.
  - 로그 변환을 통해 분포를 균형 있게 조정 가능하나 실제 값이 불균형이기 때문에 그대로 유지.
- **변수 간 관계**:
  - `WC`(현재일기 코드) 값 분포를 바 차트로 시각화.

---

EDA 결과를 바탕으로, 데이터 전처리 및 모델링에 필요한 인사이트를 도출하였습니다. 특히, `WC`(현재일기 코드)와 구름 관련 변수(`CA`, `CT`, `CH`)는 시정 예측에 중요한 영향을 미칠 것으로 예상됩니다.

---

## Notes

- 본 코드는 공군 AI 해커톤 본선에서 사용된 코드를 기반으로 작성되었으며, 공공데이터를 활용할 수 있도록 일부 수정 및 리팩토링되었습니다.
- 해커톤 당시의 코드와 동일한 로직을 유지하면서도, 실제 데이터에 적용 가능하도록 개선하였습니다.